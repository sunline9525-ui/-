<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¹œêµ¬ë¥¼ ì°¾ì•„ì¤˜!</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #f9a8ff 0%, #1f2937 65%);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
    }

    #gameContainer {
      width: 900px;
      height: 550px;
      background: linear-gradient(135deg, #f9a8ff 0%, #a855f7 40%, #6366f1 100%);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      position: relative;
      overflow: hidden;
      padding: 16px;
    }

    #hud {
      position: absolute;
      top: 16px;
      left: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
      pointer-events: none;
      font-weight: 600;
    }

    #timer {
      font-size: 18px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.25);
      backdrop-filter: blur(6px);
    }

    #lives {
      font-size: 20px;
      display: flex;
      gap: 4px;
    }

    .heart {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(248, 113, 113, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 8px rgba(248, 113, 113, 0.8);
      transition: filter 0.2s, opacity 0.2s;
    }

    .heart span {
      font-size: 16px;
    }

    .heart.lost {
      filter: grayscale(1);
      opacity: 0.3;
      box-shadow: none;
    }

    #playArea {
      position: absolute;
      left: 16px;
      right: 16px;
      top: 56px;
      bottom: 16px;
      border-radius: 20px;
      overflow: hidden;
      background: linear-gradient(
        to bottom,
        #fdf2ff 0%,
        #fdf2ff 30%,
        #e5e7eb 30%,
        #e5e7eb 65%,
        #f5f3ff 65%,
        #f5f3ff 100%
      );
    }

    /* ë„ë¡œ ê³µí†µ */
    .road {
      position: absolute;
      left: 0;
      right: 0;
      height: 16%;
      background: repeating-linear-gradient(
        90deg,
        #111827 0,
        #111827 40px,
        #0b1120 40px,
        #0b1120 80px
      );
      box-shadow: inset 0 6px 0 rgba(148, 163, 184, 0.6),
        inset 0 -6px 0 rgba(148, 163, 184, 0.6);
    }

    /* ìœ„ / ì•„ë˜ ë„ë¡œ ìœ„ì¹˜ */
    .topRoad {
      top: 34%;
    }

    .bottomRoad {
      top: 56%;
    }

    .roadStripe {
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      height: 6px;
      transform: translateY(-50%);
      background-image: linear-gradient(
        to right,
        #facc15 0,
        #facc15 40px,
        transparent 40px,
        transparent 70px
      );
      background-size: 70px 100%;
      opacity: 0.9;
    }

    /* ì§‘ê³¼ ì¹œêµ¬ë“¤ */
    .houses {
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      padding: 0 48px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      z-index: 3;
    }

    .house {
      width: 130px;
      height: 130px;
      background: linear-gradient(145deg, #fdf2ff, #e0e7ff);
      border-radius: 20px;
      position: relative;
      box-shadow: 0 10px 20px rgba(148, 163, 184, 0.6);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 16px;
      overflow: visible;
    }

    .houseRoof {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 110%;
      height: 40px;
      background: linear-gradient(135deg, #ec4899, #a855f7);
      border-radius: 20px 20px 10px 10px;
      box-shadow: 0 6px 10px rgba(236, 72, 153, 0.6);
    }

    .houseLabel {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      background: rgba(15, 23, 42, 0.7);
      color: #f9fafb;
    }

    .friend {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      background: #fef2f2;
      border: 2px solid #fb7185;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #be123c;
      position: relative;
      box-shadow: 0 6px 10px rgba(248, 113, 113, 0.7);
    }

    .friend.matched {
      display: none;
    }

    .clearedMark {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid #22c55e;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(34, 197, 94, 0.1);
      font-size: 14px;
      color: #22c55e;
      font-weight: 800;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    /* í”Œë ˆì´ì–´ */
    #player {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #f9fafb, #e0e7ff);
      border: 3px solid rgba(79, 70, 229, 0.9);
      box-shadow: 0 10px 18px rgba(79, 70, 229, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #312e81;
      font-weight: 800;
      font-size: 15px;
      z-index: 5;
      pointer-events: none;
    }

    #player::after {
      content: "â€¢á´—â€¢";
      position: absolute;
      bottom: 6px;
      font-size: 14px;
      color: #3b0764;
      opacity: 0.8;
    }

    /* ìë™ì°¨ ì¥ì• ë¬¼ */
    .obstacle {
      position: absolute;
      width: 70px;
      height: 30px;
      border-radius: 10px;
      background: linear-gradient(90deg, #4b5563, #9ca3af);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: #fee2e2;
      border: 2px solid rgba(15, 23, 42, 0.8);
    }

    /* ì˜¤ë²„ë ˆì´ (ì‹œì‘, ì„ íƒ, ê²°ê³¼) */
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.18), rgba(15, 23, 42, 0.9));
      backdrop-filter: blur(6px);
      z-index: 20;
      text-align: center;
      padding: 24px;
    }

    .overlayCard {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 24px;
      padding: 28px 32px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
    }

    .overlayTitle {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .overlaySub {
      font-size: 15px;
      opacity: 0.85;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .overlaySmall {
      font-size: 13px;
      opacity: 0.8;
      margin-bottom: 16px;
    }

    .buttonRow {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    button {
      border: none;
      outline: none;
      cursor: pointer;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 15px;
      font-weight: 600;
      color: #0b1120;
      background: linear-gradient(135deg, #f9a8ff, #818cf8);
      box-shadow: 0 8px 18px rgba(129, 140, 248, 0.7);
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
      white-space: nowrap;
    }

    button:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 10px 22px rgba(129, 140, 248, 0.9);
      filter: brightness(1.08);
    }

    button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 4px 12px rgba(129, 140, 248, 0.8);
    }

    .buttonGhost {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: none;
    }

    .buttonGhost:hover {
      box-shadow: 0 6px 14px rgba(148, 163, 184, 0.6);
      filter: none;
    }

    .hidden {
      display: none !important;
    }

    #resultScore {
      font-size: 18px;
      margin-top: 10px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <!-- HUD -->
    <div id="hud">
      <div id="timer">Time 00.0s</div>
      <div id="lives">
        <div class="heart" data-life="1"><span>â™¥</span></div>
        <div class="heart" data-life="2"><span>â™¥</span></div>
        <div class="heart" data-life="3"><span>â™¥</span></div>
      </div>
    </div>

    <!-- ê²Œì„ ì˜ì—­ -->
    <div id="playArea">
      <!-- ë„ë¡œ 2ê°œ -->
      <div class="road topRoad">
        <div class="roadStripe"></div>
      </div>
      <div class="road bottomRoad">
        <div class="roadStripe"></div>
      </div>

      <!-- ì§‘ 4ê°œì™€ ì¹œêµ¬ë“¤ -->
      <div class="houses">
        <div class="house" data-index="0" data-type="ì–´ë¯¸">
          <div class="houseRoof"></div>
          <div class="houseLabel">ì§‘ 1</div>
          <div class="friend" data-friend-index="0" data-friend-type="ì–´ë¯¸">ì–´ë¯¸</div>
        </div>
        <div class="house" data-index="1" data-type="ì ‘ì‚¬">
          <div class="houseRoof"></div>
          <div class="houseLabel">ì§‘ 2</div>
          <div class="friend" data-friend-index="1" data-friend-type="ì ‘ì‚¬">ì ‘ì‚¬</div>
        </div>
        <div class="house" data-index="2" data-type="ì–´ë¯¸">
          <div class="houseRoof"></div>
          <div class="houseLabel">ì§‘ 3</div>
          <div class="friend" data-friend-index="2" data-friend-type="ì–´ë¯¸">ì–´ë¯¸</div>
        </div>
        <div class="house" data-index="3" data-type="ì ‘ì‚¬">
          <div class="houseRoof"></div>
          <div class="houseLabel">ì§‘ 4</div>
          <div class="friend" data-friend-index="3" data-friend-type="ì ‘ì‚¬">ì ‘ì‚¬</div>
        </div>
      </div>

      <!-- í”Œë ˆì´ì–´ -->
      <div id="player" class="hidden">ì–´ê°„</div>

      <!-- ìë™ì°¨ ì¥ì• ë¬¼ 6ê°œ -->
      <div class="obstacle" data-index="0">ğŸš—</div>
      <div class="obstacle" data-index="1">ğŸš•</div>
      <div class="obstacle" data-index="2">ğŸš™</div>
      <div class="obstacle" data-index="3">ğŸšŒ</div>
      <div class="obstacle" data-index="4">ğŸš“</div>
      <div class="obstacle" data-index="5">ğŸš‘</div>
    </div>

    <!-- ì‹œì‘ í™”ë©´ + ë‚œì´ë„ ì„ íƒ -->
    <div id="startOverlay" class="overlay">
      <div class="overlayCard">
        <div class="overlayTitle">ì¹œêµ¬ë¥¼ ì°¾ì•„ì¤˜! ğŸ’œ</div>
        <div class="overlaySub">
          'ì–´ê°„'ê³¼ 'ì–´ê·¼'ì„ ì¡°ì‘í•´ì„œ<br />
          ê¸¸ ê±´ë„ˆí¸ì˜ <b>'ì–´ë¯¸'ì™€ 'ì ‘ì‚¬'</b>ì—ê²Œ <b>ì˜¬ë°”ë¥¸ ì§</b>ì„ ì°¾ì•„ì¤˜!<br /><br />
          ë°©í–¥í‚¤(â†‘â†“â†â†’)ë¡œ ì›€ì§ì´ë©° <b>ìë™ì°¨ë¥¼ í”¼í•´</b> ì›€ì§ì´ì„¸ìš”.
        </div>
        <div class="overlaySmall">
        </div>
        <div class="buttonRow">
          <button class="difficultyButton" data-difficulty="normal">ë³´í†µ</button>
          <button class="difficultyButton" data-difficulty="hard">ì–´ë ¤ì›€</button>
        </div>
      </div>
    </div>

    <!-- ì–´ê°„ / ì–´ê·¼ ì„ íƒ í™”ë©´ -->
    <div id="choiceOverlay" class="overlay hidden">
      <div class="overlayCard">
        <div class="overlayTitle">ëˆ„êµ¬ë¥¼ ë„ì™€ì¤„ê¹Œ? ğŸ¤”</div>
        <div class="overlaySub">
          ì›€ì§ì¼ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.
        </div>
        <div class="buttonRow">
          <button class="chooseButton" data-choice="ì–´ê°„">ì–´ê°„</button>
          <button class="chooseButton" data-choice="ì–´ê·¼">ì–´ê·¼</button>
        </div>
      </div>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ (í´ë¦¬ì–´ / ê²Œì„ì˜¤ë²„ ê³µìš©) -->
    <div id="resultOverlay" class="overlay hidden">
      <div class="overlayCard">
        <div id="resultTitle" class="overlayTitle">Game Over ğŸ’”</div>
        <div id="resultMessage" class="overlaySub">
          ë‹¤ì‹œ í•œ ë²ˆ ë„ì „í•´ë³¼ê¹Œìš”?
        </div>
        <div id="resultScore"></div>
        <div class="buttonRow" style="margin-top: 18px;">
          <button id="retryButton">ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>
          <button id="quitButton" class="buttonGhost">ì²˜ìŒ í™”ë©´ìœ¼ë¡œ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // ê¸°ë³¸ ìƒíƒœ ë³€ìˆ˜
    // -----------------------------
    const playArea = document.getElementById("playArea");
    const playerEl = document.getElementById("player");
    const obstacles = Array.from(document.querySelectorAll(".obstacle"));
    const hearts = Array.from(document.querySelectorAll(".heart"));
    const friends = Array.from(document.querySelectorAll(".friend"));
    const houses = Array.from(document.querySelectorAll(".house"));

    const startOverlay = document.getElementById("startOverlay");
    const choiceOverlay = document.getElementById("choiceOverlay");
    const resultOverlay = document.getElementById("resultOverlay");
    const resultTitle = document.getElementById("resultTitle");
    const resultMessage = document.getElementById("resultMessage");
    const resultScoreEl = document.getElementById("resultScore");

    const timerEl = document.getElementById("timer");

    let gameState = "start"; // start / choosing / playing / gameover / clear
    let currentController = null; // "ì–´ê°„" ë˜ëŠ” "ì–´ê·¼"

    let lives = 3;
    let matchedCount = 0;
    const totalFriends = friends.length;

    let startTime = 0;
    let timerInterval = null;

    let player = {
      x: 0,
      y: 0,
      speed: 4,
      width: 60,
      height: 60,
    };

    let keysPressed = {};
    let obstacleStates = [];
    let interactionLocked = false; // ì¹œêµ¬ì™€ ë§Œë‚œ ì§í›„ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€

    // ë‚œì´ë„: "normal" ë˜ëŠ” "hard"
    let difficulty = "hard";

    // -----------------------------
    // ìœ í‹¸ í•¨ìˆ˜
    // -----------------------------
    function rectsOverlap(r1, r2) {
      return !(
        r1.right < r2.left ||
        r1.left > r2.right ||
        r1.bottom < r2.top ||
        r1.top > r2.bottom
      );
    }

    function formatTime(ms) {
      const sec = ms / 1000;
      return sec.toFixed(1) + "s";
    }

    // -----------------------------
    // íƒ€ì´ë¨¸
    // -----------------------------
    function startTimer() {
      stopTimer();
      startTime = performance.now();
      timerInterval = setInterval(() => {
        const now = performance.now();
        timerEl.textContent = "Time " + formatTime(now - startTime);
      }, 100);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // -----------------------------
    // ëª©ìˆ¨ UI
    // -----------------------------
    function refreshLivesUI() {
      hearts.forEach((heart, index) => {
        const lifeNumber = index + 1;
        if (lifeNumber <= lives) {
          heart.classList.remove("lost");
        } else {
          heart.classList.add("lost");
        }
      });
    }

    function loseLife() {
      if (lives <= 0) return;
      lives--;
      refreshLivesUI();

      if (lives <= 0) {
        handleGameOver();
      }
    }

    // -----------------------------
    // í”Œë ˆì´ì–´ ê´€ë ¨
    // -----------------------------
    function resetPlayerPosition() {
      const rect = playArea.getBoundingClientRect();
      player.x = rect.width / 2 - player.width / 2;
      player.y = rect.height - player.height - 20;
      updatePlayerElement();
    }

    function setPlayerLabel(name) {
      playerEl.textContent = name;
    }

    function updatePlayerElement() {
      playerEl.style.left = player.x + "px";
      playerEl.style.top = player.y + "px";
    }

    // -----------------------------
    // ì¥ì• ë¬¼ ê´€ë ¨ (2ê°œì˜ ë„ë¡œì— ë°°ì¹˜ + ë‚œì´ë„ ë°˜ì˜)
    // -----------------------------
    function initObstacles() {
      const rect = playArea.getBoundingClientRect();

      const roadHeight = rect.height * 0.16;
      const roadTop1 = rect.height * 0.34;
      const roadTop2 = rect.height * 0.56;

      const lanesPerRoad = Math.ceil(obstacles.length / 2);
      const difficultyFactor = difficulty === "normal" ? 0.3 : 1.0; // ë³´í†µ = 80% ì†ë„

      obstacleStates = obstacles.map((obEl, index) => {
        const isTop = index < lanesPerRoad;
        const laneIndex = isTop ? index : index - lanesPerRoad;
        const roadTop = isTop ? roadTop1 : roadTop2;

        const ratio =
          lanesPerRoad > 1 ? laneIndex / (lanesPerRoad - 1) : 0.5;

        const laneY = roadTop + roadHeight * 0.2 + ratio * roadHeight * 0.6;

        const direction = index % 2 === 0 ? 1 : -1;
        const baseSpeed = 2 + index * 0.4;      // ê¸°ì¡´ ì†ë„
        const speed = baseSpeed * difficultyFactor; // ë‚œì´ë„ ë°˜ì˜

        const startX = direction === 1 ? -80 : rect.width + 80;

        obEl.style.top = laneY + "px";

        return {
          el: obEl,
          x: startX,
          y: laneY,
          direction,
          speed,
        };
      });
    }

    function updateObstacles() {
      if (gameState !== "playing") return;
      const rect = playArea.getBoundingClientRect();

      obstacleStates.forEach((obs) => {
        obs.x += obs.speed * obs.direction;

        if (obs.direction === 1 && obs.x > rect.width + 100) {
          obs.x = -80;
        } else if (obs.direction === -1 && obs.x < -120) {
          obs.x = rect.width + 80;
        }

        obs.el.style.left = obs.x + "px";
      });
    }

    // -----------------------------
    // ì¹œêµ¬/ì§‘ ìƒíƒœ ê´€ë ¨
    // -----------------------------
    function resetFriends() {
      matchedCount = 0;
      friends.forEach((f) => {
        f.classList.remove("matched");
      });
      houses.forEach((house) => {
        const oldMark = house.querySelector(".clearedMark");
        if (oldMark) oldMark.remove();
      });
    }

    function handleFriendCollision(friendEl) {
      if (interactionLocked) return;
      interactionLocked = true;

      const targetType = friendEl.dataset.friendType; // "ì–´ë¯¸" ë˜ëŠ” "ì ‘ì‚¬"
      const isCorrect =
        (currentController === "ì–´ê°„" && targetType === "ì–´ë¯¸") ||
        (currentController === "ì–´ê·¼" && targetType === "ì ‘ì‚¬");

      if (isCorrect) {
        // ë§ëŠ” ì§!
        friendEl.classList.add("matched");
        matchedCount++;

        const house = friendEl.closest(".house");
        if (house) {
          const mark = document.createElement("div");
          mark.className = "clearedMark";
          mark.textContent = "âœ”";
          house.appendChild(mark);
        }

        if (matchedCount >= totalFriends) {
          // ê²Œì„ í´ë¦¬ì–´
          handleGameClear();
          return;
        } else {
          // ë‹¤ìŒ ì„ íƒ
          setTimeout(() => {
            showChoice();
            resetPlayerPosition();
            interactionLocked = false;
          }, 400);
        }
      } else {
        // í‹€ë¦° ì¹œêµ¬ ë§Œë‚¨ â†’ ëª©ìˆ¨ ê°ì†Œ
        loseLife();
        if (lives > 0) {
          setTimeout(() => {
            showChoice();
            resetPlayerPosition();
            interactionLocked = false;
          }, 400);
        }
      }
    }

    // -----------------------------
    // ê²Œì„ ìƒíƒœ ì „í™˜
    // -----------------------------
    function startGame() {
      gameState = "choosing";
      lives = 3;
      refreshLivesUI();
      resetFriends();
      resetPlayerPosition();
      playerEl.classList.add("hidden");
      initObstacles();
      startTimer();
      startOverlay.classList.add("hidden");
      choiceOverlay.classList.remove("hidden");
      resultOverlay.classList.add("hidden");
      interactionLocked = false;
    }

    function showChoice() {
      gameState = "choosing";
      choiceOverlay.classList.remove("hidden");
      playerEl.classList.add("hidden");
    }

    function startRound(controllerName) {
      currentController = controllerName; // "ì–´ê°„" or "ì–´ê·¼"
      setPlayerLabel(controllerName);
      resetPlayerPosition();
      playerEl.classList.remove("hidden");
      choiceOverlay.classList.add("hidden");
      gameState = "playing";
      interactionLocked = false;
    }

    function handleGameOver() {
      gameState = "gameover";
      stopTimer();
      playerEl.classList.add("hidden");
      choiceOverlay.classList.add("hidden");

      resultTitle.textContent = "Game Over ğŸ’”";
      resultMessage.textContent = "ëª©ìˆ¨ì´ ëª¨ë‘ ì‚¬ë¼ì¡Œì–´ìš”. ë‹¤ì‹œ ë„ì „í•´ë³¼ê¹Œìš”?";
      resultScoreEl.textContent = "";
      resultOverlay.classList.remove("hidden");
    }

    function handleGameClear() {
      gameState = "clear";
      stopTimer();
      playerEl.classList.add("hidden");
      choiceOverlay.classList.add("hidden");

      const elapsedMs = performance.now() - startTime;
      const elapsedSec = elapsedMs / 1000;

      // ê°„ë‹¨ ì ìˆ˜ ê³„ì‚°: ê¸°ë³¸ 10000ì  - ì‹œê°„ * 150 + ë‚¨ì€ ëª©ìˆ¨ * 500
      let score = Math.max(
        0,
        Math.round(10000 - elapsedSec * 150 + lives * 500)
      );

      resultTitle.textContent = "Game Clear! ğŸ‰";
      resultMessage.textContent =
        "ëª¨ë“  ì¹œêµ¬ì—ê²Œ ì˜¬ë°”ë¥¸ ì§ì„ ì°¾ì•„ì¤¬ì–´ìš”! ë©‹ì ¸ìš” âœ¨";
      resultScoreEl.textContent =
        "í´ë¦¬ì–´ ì‹œê°„: " +
        formatTime(elapsedMs) +
        " Â· ì ìˆ˜: " +
        score.toLocaleString("ko-KR") +
        "ì ";
      resultOverlay.classList.remove("hidden");
    }

    function resetToStart() {
      gameState = "start";
      stopTimer();
      timerEl.textContent = "Time 00.0s";
      lives = 3;
      refreshLivesUI();
      resetFriends();
      playerEl.classList.add("hidden");
      resultOverlay.classList.add("hidden");
      choiceOverlay.classList.add("hidden");
      startOverlay.classList.remove("hidden");
    }

    function retryGame() {
      resetToStart();
    }

    // -----------------------------
    // ì…ë ¥ ì²˜ë¦¬ (í‚¤ë³´ë“œ)
    // -----------------------------
    window.addEventListener("keydown", (e) => {
      if (
        ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(
          e.key
        )
      ) {
        e.preventDefault();
      }

      if (gameState === "playing") {
        if (e.key === "ArrowUp") keysPressed["up"] = true;
        if (e.key === "ArrowDown") keysPressed["down"] = true;
        if (e.key === "ArrowLeft") keysPressed["left"] = true;
        if (e.key === "ArrowRight") keysPressed["right"] = true;
      }
    });

    window.addEventListener("keyup", (e) => {
      if (e.key === "ArrowUp") keysPressed["up"] = false;
      if (e.key === "ArrowDown") keysPressed["down"] = false;
      if (e.key === "ArrowLeft") keysPressed["left"] = false;
      if (e.key === "ArrowRight") keysPressed["right"] = false;
    });

    // -----------------------------
    // ë©”ì¸ ê²Œì„ ë£¨í”„
    // -----------------------------
    function gameLoop() {
      const rect = playArea.getBoundingClientRect();

      if (gameState === "playing") {
        // ì´ë™
        if (keysPressed["up"]) {
          player.y -= player.speed;
        }
        if (keysPressed["down"]) {
          player.y += player.speed;
        }
        if (keysPressed["left"]) {
          player.x -= player.speed;
        }
        if (keysPressed["right"]) {
          player.x += player.speed;
        }

        // ì˜ì—­ ì œí•œ
        player.x = Math.max(0, Math.min(rect.width - player.width, player.x));
        player.y = Math.max(0, Math.min(rect.height - player.height, player.y));

        updatePlayerElement();

        // ì¥ì• ë¬¼ ì—…ë°ì´íŠ¸ & ì¶©ëŒ ì²´í¬
        updateObstacles();

        const playerRect = playerEl.getBoundingClientRect();

        for (const obs of obstacleStates) {
          const oRect = obs.el.getBoundingClientRect();
          if (rectsOverlap(playerRect, oRect)) {
            loseLife();
            resetPlayerPosition();
            break;
          }
        }

        // ì¹œêµ¬ ì¶©ëŒ ì²´í¬
        for (const friendEl of friends) {
          if (friendEl.classList.contains("matched")) continue;
          const fRect = friendEl.getBoundingClientRect();
          if (rectsOverlap(playerRect, fRect)) {
            handleFriendCollision(friendEl);
            break;
          }
        }
      }

      requestAnimationFrame(gameLoop);
    }

    // -----------------------------
    // ë²„íŠ¼ ì´ë²¤íŠ¸
    // -----------------------------
    // ë‚œì´ë„ ì„ íƒ ë²„íŠ¼
    Array.from(document.querySelectorAll(".difficultyButton")).forEach((btn) => {
      btn.addEventListener("click", () => {
        difficulty = btn.dataset.difficulty; // "normal" or "hard"
        startGame();
      });
    });

    Array.from(document.querySelectorAll(".chooseButton")).forEach((btn) => {
      btn.addEventListener("click", () => {
        const choice = btn.dataset.choice; // "ì–´ê°„" or "ì–´ê·¼"
        startRound(choice);
      });
    });

    document.getElementById("retryButton").addEventListener("click", () => {
      retryGame();
    });

    document.getElementById("quitButton").addEventListener("click", () => {
      resetToStart();
    });

    // -----------------------------
    // ì´ˆê¸°í™” & ë£¨í”„ ì‹œì‘
    // -----------------------------
    window.addEventListener("load", () => {
      resetToStart();
      initObstacles();
      requestAnimationFrame(gameLoop);
    });
  </script>
</body>
</html>
